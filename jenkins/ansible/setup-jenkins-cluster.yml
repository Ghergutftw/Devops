---
- name: Configure All Jenkins Nodes
  hosts: all
  become: yes
  tasks:
    - name: Update apt cache and install Java
      apt:
        name: openjdk-11-jdk
        state: present
        update_cache: yes

- name: Configure Jenkins Master
  hosts: jenkins_master
  become: yes
  tasks:
    - name: Add Jenkins repository key
      apt_key:
        url: https://pkg.jenkins.io/debian-stable/jenkins.io-2023.key
        state: present

    - name: Add Jenkins repository
      apt_repository:
        repo: deb https://pkg.jenkins.io/debian-stable binary/
        state: present

    - name: Install Jenkins
      apt:
        name: jenkins
        state: present
        update_cache: yes

    - name: Start and enable Jenkins service
      service:
        name: jenkins
        state: started
        enabled: yes

    - name: Wait for Jenkins to start
      wait_for:
        port: 8080
        delay: 15
        timeout: 300

    - name: Generate SSH key for jenkins user
      user:
        name: jenkins
        generate_ssh_key: yes
        ssh_key_bits: 2048
        ssh_key_file: .ssh/id_rsa

    - name: Fetch the Jenkins user public key
      fetch:
        src: /var/lib/jenkins/.ssh/id_rsa.pub
        dest: /tmp/jenkins_master_key.pub
        flat: yes

- name: Configure Jenkins Slave Nodes
  hosts: jenkins_slaves
  become: yes
  tasks:
    - name: Create a jenkins user
      user:
        name: jenkins
        shell: /bin/bash
        create_home: yes
        state: present

    - name: Authorize the master's public key
      authorized_key:
        user: jenkins
        state: present
        key: "{{ lookup('file', '/tmp/jenkins_master_key.pub') }}"